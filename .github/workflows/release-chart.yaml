name: Helm Chart CI/CD

on:
  pull_request:
    paths:
      - 'Chart.yaml'
      - 'values.yaml'
      - 'templates/**'
      - 'manifests-crds/**'
      - 'manifests-presync/**'
      - 'environments/**'
      - 'helmfile.yaml.gotmpl'
  push:
    branches:
      - main
    paths:
      - 'Chart.yaml'
      - 'values.yaml'
      - 'templates/**'
      - 'manifests-crds/**'
      - 'manifests-presync/**'
      - 'environments/**'
      - 'helmfile.yaml.gotmpl'
  workflow_dispatch:

jobs:
  # Run on PRs - lint and test only
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Helm
        run: |
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Lint Chart
        run: helm lint .

      - name: Template Chart
        run: helm template test . > /dev/null

  # Run on main - auto-bump version and publish
  release:
    if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && github.ref == 'refs/heads/main'
    needs: lint
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Install Helm
        run: |
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Auto-bump patch version
        id: chart
        run: |
          # Get current version
          CURRENT=$(grep '^version:' Chart.yaml | awk '{print $2}')
          echo "Current version: $CURRENT"

          # Parse and bump patch version
          MAJOR=$(echo $CURRENT | cut -d. -f1)
          MINOR=$(echo $CURRENT | cut -d. -f2)
          PATCH=$(echo $CURRENT | cut -d. -f3)
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"

          echo "New version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

          # Update Chart.yaml
          sed -i "s/^version:.*/version: $NEW_VERSION/" Chart.yaml

          # Commit version bump
          git add Chart.yaml
          git commit -m "Bump chart version to $NEW_VERSION [skip ci]"
          git pull --rebase origin main
          git push

      - name: Package Chart
        run: helm package . -d .deploy

      - name: Setup gh-pages branch
        run: |
          # Check if gh-pages exists remotely
          if git ls-remote --heads origin gh-pages | grep -q gh-pages; then
            echo "gh-pages exists, cloning..."
            git clone --single-branch --branch gh-pages https://github.com/${{ github.repository }}.git gh-pages
          else
            echo "gh-pages does not exist, creating..."
            mkdir gh-pages
            cd gh-pages
            git init
            git checkout -b gh-pages
            git remote add origin https://github.com/${{ github.repository }}.git
            touch .nojekyll
            git add .nojekyll
            git commit -m "Init gh-pages"
          fi

      - name: Update Helm repo index
        run: |
          cp .deploy/*.tgz gh-pages/
          cd gh-pages
          helm repo index . --url https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/ --merge index.yaml 2>/dev/null || \
          helm repo index . --url https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/

      - name: Push to gh-pages
        run: |
          cd gh-pages
          git add .
          git commit -m "Release ${{ steps.chart.outputs.version }}"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git push origin gh-pages --force
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "### Chart Published" >> $GITHUB_STEP_SUMMARY
          echo "- Version: ${{ steps.chart.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_STEP_SUMMARY
